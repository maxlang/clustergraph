<!DOCTYPE html>
<meta charset="utf-8">
<style>
.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}
.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}
</style>

<select width="200px" style="width:3000px">
<option>build.timestamp</option>
<option>clock-offset.meannanos</option>
<option>clock-offset.stddevnanos</option>
<option>distsender.batches</option>
<option>distsender.batches.partial</option>
<option>distsender.errors.notleaseholder</option>
<option>distsender.rpc.sent</option>
<option>distsender.rpc.sent.local</option>
<option>distsender.rpc.sent.nextreplicaerror</option>
<option>distsender.rpc.sent.sendnexttimeout</option>
<option>exec.error</option>
<option>exec.latency-max</option>
<option>exec.latency-p50</option>
<option>exec.latency-p75</option>
<option>exec.latency-p90</option>
<option>exec.latency-p99</option>
<option>exec.latency-p99.9</option>
<option>exec.latency-p99.99</option>
<option>exec.latency-p99.999</option>
<option>exec.success</option>
<option>gossip.bytes.received</option>
<option>gossip.bytes.sent</option>
<option>gossip.connections.incoming</option>
<option>gossip.connections.outgoing</option>
<option>gossip.connections.refused</option>
<option>gossip.infos.received</option>
<option>gossip.infos.sent</option>
<option>liveness.epochincrements</option>
<option>liveness.heartbeatfailures</option>
<option>liveness.heartbeatsuccesses</option>
<option>liveness.livenodes</option>
<option>requests.slow.distsender</option>
<option>sql.bytesin</option>
<option>sql.bytesout</option>
<option>sql.conns</option>
<option>sql.ddl.count</option>
<option>sql.delete.count</option>
<option>sql.distsql.select.count</option>
<option>sql.insert.count</option>
<option>sql.latency-max</option>
<option>sql.latency-p50</option>
<option>sql.latency-p75</option>
<option>sql.latency-p90</option>
<option>sql.latency-p99</option>
<option>sql.latency-p99.9</option>
<option>sql.latency-p99.99</option>
<option>sql.latency-p99.999</option>
<option>sql.misc.count</option>
<option>sql.mon.admin.cur</option>
<option>sql.mon.admin.max-max</option>
<option>sql.mon.admin.max-p50</option>
<option>sql.mon.admin.max-p75</option>
<option>sql.mon.admin.max-p90</option>
<option>sql.mon.admin.max-p99</option>
<option>sql.mon.admin.max-p99.9</option>
<option>sql.mon.admin.max-p99.99</option>
<option>sql.mon.admin.max-p99.999</option>
<option>sql.mon.admin.session.cur</option>
<option>sql.mon.admin.session.max-max</option>
<option>sql.mon.admin.session.max-p50</option>
<option>sql.mon.admin.session.max-p75</option>
<option>sql.mon.admin.session.max-p90</option>
<option>sql.mon.admin.session.max-p99</option>
<option>sql.mon.admin.session.max-p99.9</option>
<option>sql.mon.admin.session.max-p99.99</option>
<option>sql.mon.admin.session.max-p99.999</option>
<option>sql.mon.admin.txn.cur</option>
<option>sql.mon.admin.txn.max-max</option>
<option>sql.mon.admin.txn.max-p50</option>
<option>sql.mon.admin.txn.max-p75</option>
<option>sql.mon.admin.txn.max-p90</option>
<option>sql.mon.admin.txn.max-p99</option>
<option>sql.mon.admin.txn.max-p99.9</option>
<option>sql.mon.admin.txn.max-p99.99</option>
<option>sql.mon.admin.txn.max-p99.999</option>
<option>sql.mon.client.cur</option>
<option>sql.mon.client.max-max</option>
<option>sql.mon.client.max-p50</option>
<option>sql.mon.client.max-p75</option>
<option>sql.mon.client.max-p90</option>
<option>sql.mon.client.max-p99</option>
<option>sql.mon.client.max-p99.9</option>
<option>sql.mon.client.max-p99.99</option>
<option>sql.mon.client.max-p99.999</option>
<option>sql.mon.client.session.cur</option>
<option>sql.mon.client.session.max-max</option>
<option>sql.mon.client.session.max-p50</option>
<option>sql.mon.client.session.max-p75</option>
<option>sql.mon.client.session.max-p90</option>
<option>sql.mon.client.session.max-p99</option>
<option>sql.mon.client.session.max-p99.9</option>
<option>sql.mon.client.session.max-p99.99</option>
<option>sql.mon.client.session.max-p99.999</option>
<option>sql.mon.client.txn.cur</option>
<option>sql.mon.client.txn.max-max</option>
<option>sql.mon.client.txn.max-p50</option>
<option>sql.mon.client.txn.max-p75</option>
<option>sql.mon.client.txn.max-p90</option>
<option>sql.mon.client.txn.max-p99</option>
<option>sql.mon.client.txn.max-p99.9</option>
<option>sql.mon.client.txn.max-p99.99</option>
<option>sql.mon.client.txn.max-p99.999</option>
<option>sql.mon.conns.cur</option>
<option>sql.mon.conns.max-max</option>
<option>sql.mon.conns.max-p50</option>
<option>sql.mon.conns.max-p75</option>
<option>sql.mon.conns.max-p90</option>
<option>sql.mon.conns.max-p99</option>
<option>sql.mon.conns.max-p99.9</option>
<option>sql.mon.conns.max-p99.99</option>
<option>sql.mon.conns.max-p99.999</option>
<option>sql.mon.conns.session.cur</option>
<option>sql.mon.conns.session.max-max</option>
<option>sql.mon.conns.session.max-p50</option>
<option>sql.mon.conns.session.max-p75</option>
<option>sql.mon.conns.session.max-p90</option>
<option>sql.mon.conns.session.max-p99</option>
<option>sql.mon.conns.session.max-p99.9</option>
<option>sql.mon.conns.session.max-p99.99</option>
<option>sql.mon.conns.session.max-p99.999</option>
<option>sql.mon.conns.txn.cur</option>
<option>sql.mon.conns.txn.max-max</option>
<option>sql.mon.conns.txn.max-p50</option>
<option>sql.mon.conns.txn.max-p75</option>
<option>sql.mon.conns.txn.max-p90</option>
<option>sql.mon.conns.txn.max-p99</option>
<option>sql.mon.conns.txn.max-p99.9</option>
<option>sql.mon.conns.txn.max-p99.99</option>
<option>sql.mon.conns.txn.max-p99.999</option>
<option>sql.mon.internal.cur</option>
<option>sql.mon.internal.max-max</option>
<option>sql.mon.internal.max-p50</option>
<option>sql.mon.internal.max-p75</option>
<option>sql.mon.internal.max-p90</option>
<option>sql.mon.internal.max-p99</option>
<option>sql.mon.internal.max-p99.9</option>
<option>sql.mon.internal.max-p99.99</option>
<option>sql.mon.internal.max-p99.999</option>
<option>sql.mon.internal.session.cur</option>
<option>sql.mon.internal.session.max-max</option>
<option>sql.mon.internal.session.max-p50</option>
<option>sql.mon.internal.session.max-p75</option>
<option>sql.mon.internal.session.max-p90</option>
<option>sql.mon.internal.session.max-p99</option>
<option>sql.mon.internal.session.max-p99.9</option>
<option>sql.mon.internal.session.max-p99.99</option>
<option>sql.mon.internal.session.max-p99.999</option>
<option>sql.mon.internal.txn.cur</option>
<option>sql.mon.internal.txn.max-max</option>
<option>sql.mon.internal.txn.max-p50</option>
<option>sql.mon.internal.txn.max-p75</option>
<option>sql.mon.internal.txn.max-p90</option>
<option>sql.mon.internal.txn.max-p99</option>
<option>sql.mon.internal.txn.max-p99.9</option>
<option>sql.mon.internal.txn.max-p99.99</option>
<option>sql.mon.internal.txn.max-p99.999</option>
<option>sql.query.count</option>
<option>sql.select.count</option>
<option>sql.txn.abort.count</option>
<option>sql.txn.begin.count</option>
<option>sql.txn.commit.count</option>
<option>sql.txn.rollback.count</option>
<option>sql.update.count</option>
<option>sys.cgo.allocbytes</option>
<option>sys.cgo.totalbytes</option>
<option>sys.cgocalls</option>
<option>sys.cpu.sys.ns</option>
<option>sys.cpu.sys.percent</option>
<option>sys.cpu.user.ns</option>
<option>sys.cpu.user.percent</option>
<option>sys.fd.open</option>
<option>sys.fd.softlimit</option>
<option>sys.gc.count</option>
<option>sys.gc.pause.ns</option>
<option>sys.gc.pause.percent</option>
<option>sys.go.allocbytes</option>
<option>sys.go.totalbytes</option>
<option>sys.goroutines</option>
<option>sys.rss</option>
<option>sys.uptime</option>
<option>txn.abandons</option>
<option>txn.aborts</option>
<option>txn.commits</option>
<option>txn.commits1PC</option>
<option>txn.durations-max</option>
<option>txn.durations-p50</option>
<option>txn.durations-p75</option>
<option>txn.durations-p90</option>
<option>txn.durations-p99</option>
<option>txn.durations-p99.9</option>
<option>txn.durations-p99.99</option>
<option>txn.durations-p99.999</option>
<option>txn.restarts-max</option>
<option>txn.restarts-p50</option>
<option>txn.restarts-p75</option>
<option>txn.restarts-p90</option>
<option>txn.restarts-p99</option>
<option>txn.restarts-p99.9</option>
<option>txn.restarts-p99.99</option>
<option>txn.restarts-p99.999</option>
</select>

<svg width="960" height="600"></svg>
<script src="./node_modules/d3/build/d3.js"></script>
<script src="./node_modules/lodash/lodash.js"></script>
<script src="./node_modules/jquery/dist/jquery.js"></script>
<script src="./node_modules/select2/dist/js/select2.js"></script>
<link href="./node_modules/select2/dist/css/select2.css" rel="stylesheet" />

<script>

function calcNodesAndLinks(n) {

  let nodes = _.map(n, (v)=> { return {id: v.desc.nodeId, metrics: v.metrics}; });
  let links = _.map(n, (v,k)=>{
    return {source: v.desc.nodeId, target: (k === n.length - 1) ? n[0].desc.nodeId : n[k + 1].desc.nodeId };
  });
  return {nodes, links};
}

  let select = $('select').select2().on('select2:select', (evt) => {
    location.replace(location.href.replace(/\?q=.*/,"").replace(/$/,`?q=${evt.params.data.id}`));
  });

function redrawGraph() {

var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

svg.html("");

var color = d3.scaleOrdinal(d3.schemeCategory20);

var simulation = d3.forceSimulation()
    .force("link", d3.forceLink().id(function(d) { return d.id; }))
    .force("charge", d3.forceManyBody().strength(-300))
    .force("center", d3.forceCenter(width / 2, height / 2));

d3.json("/_status/nodes", function(error, nodes) {

  if (error || !nodes) {
    console.error("no data", error);
    return;
  }

  let stat=location.search.replace("?q=","") || "sys.cpu.user.percent";

  let max = (nodes && stat && _.maxBy(nodes.nodes, (v) => v.metrics[stat]).metrics[stat]) || 1;

  console.log("max", max);

  let target = 25;

  let factor = 25/max;

  console.log("stat", stat, factor);

  let graph = calcNodesAndLinks(nodes.nodes);
  console.log("graph", _.cloneDeep(graph));
  if (error) throw error;
  var link = svg.append("g")
      .attr("class", "links")
    .selectAll("line")
    .data(graph.links)
    .enter().append("line")
      .attr("stroke-width", 0); //function(d) { return Math.sqrt(d.value); });

  var node = svg.append("g")
      .attr("class", "nodes")
    .selectAll(".test")
    .data(graph.nodes)
    .enter().append("g").attr("class", "test");
      // .attr("r", (d) => d.count/100)

node.append("circle")
      .attr("r", (d) => d.metrics[stat] * factor)
      .attr("fill", function(d) { return color(d.group); })
      .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

node.append("text")
  .text((d) => `node ${d.id} : ${stat}=${d.metrics[stat]}`);

  node.append("title")
  .text((d) => `node ${d.id} : ${stat}=${d.metrics[stat]}`);


  simulation
      .nodes(graph.nodes)
      .on("tick", ticked);

  simulation.force("link")
      .links(graph.links);

  function ticked() {
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node
        .attr("transform", (d)=>`translate(${d.x},${d.y})`)
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  }
});

function dragstarted(d) {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(d) {
  d.fx = d3.event.x;
  d.fy = d3.event.y;
}

function dragended(d) {
  if (!d3.event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

}

redrawGraph();


</script>
